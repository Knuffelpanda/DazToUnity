name: Build and Upload Release

on:
  release:
    types: [published]

jobs:
  build-windows:
    runs-on: [self-hosted, windows]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Verify Daz Studio SDK
        shell: bash
        run: |
          if [ ! -d "$DAZ_SDK_DIR" ]; then
            echo "::error::Daz Studio SDK not found at '$DAZ_SDK_DIR'. Set DAZ_SDK_DIR as an environment variable on the runner."
            exit 1
          fi
          echo "Daz Studio SDK found at $DAZ_SDK_DIR"

      - name: Cache FBX SDK
        id: cache-fbx-sdk
        uses: actions/cache@v4
        with:
          path: C:\FbxSdk
          key: fbx-sdk-2020.3.9

      - name: Install FBX SDK
        if: steps.cache-fbx-sdk.outputs.cache-hit != 'true'
        shell: bash
        run: |
          curl -L "https://damassets.autodesk.net/content/dam/autodesk/www/files/fbx202039_fbxsdk_vs2022_win.exe" -o /tmp/fbxsdk.exe
          # NSIS silent install â€” /D= must be a Windows absolute path and must be last
          cmd //c "/tmp/fbxsdk.exe //S //D=C:\\FbxSdk"
          # Wait for the installer to finish
          sleep 60

      - name: Cache OpenSubdiv
        id: cache-opensubdiv
        uses: actions/cache@v4
        with:
          path: C:\OpenSubdiv\install
          key: opensubdiv-3.6.0

      - name: Build OpenSubdiv
        if: steps.cache-opensubdiv.outputs.cache-hit != 'true'
        shell: bash
        run: |
          git clone --depth 1 --branch v3_6_0 https://github.com/PixarAnimationStudios/OpenSubdiv.git /c/OpenSubdiv/src
          cmake -B /c/OpenSubdiv/build -S /c/OpenSubdiv/src \
            -DNO_PTEX=ON -DNO_DOC=ON -DNO_OMP=ON -DNO_TBB=ON -DNO_CUDA=ON \
            -DNO_OPENCL=ON -DNO_CLEW=ON -DNO_GLEW=ON -DNO_GLFW=ON \
            -DNO_GLFW_X11=ON -DNO_EXAMPLES=ON -DNO_TUTORIALS=ON \
            -DNO_REGRESSION=ON -DNO_TESTS=ON \
            -DCMAKE_INSTALL_PREFIX=/c/OpenSubdiv/install
          cmake --build /c/OpenSubdiv/build --config Release --target install

      - name: Configure DazToUnity
        shell: bash
        run: |
          cmake -B build -S . \
            -DDAZ_SDK_DIR="$DAZ_SDK_DIR" \
            -DFBX_SDK_DIR="C:/FbxSdk" \
            -DFBX_SDK_LIB="C:/FbxSdk/lib/x64/release/libfbxsdk-md.lib" \
            -DFBX_SDK_XMLLIB="C:/FbxSdk/lib/x64/release/libxml2-md.lib" \
            -DOPENSUBDIV_DIR="C:/OpenSubdiv/install/include" \
            -DOPENSUBDIV_LIB="C:/OpenSubdiv/install/lib/osdCPU.lib" \
            -DCMAKE_POLICY_VERSION_MINIMUM=3.5

      - name: Build DazToUnity
        shell: bash
        run: |
          cmake --build build --config Release

      - name: Upload DLL to Release
        shell: bash
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release upload "${{ github.event.release.tag_name }}" \
            build/bin/Release/dzunitybridge.dll \
            --clobber
